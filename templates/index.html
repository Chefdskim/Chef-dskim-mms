<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef Dskim System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5f7fa; font-family: 'Pretendard', sans-serif; padding-bottom: 80px; }
        .main-container { max-width: 600px; margin: 0 auto; background: #fff; min-height: 100vh; }
        
        /* íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .nav-pills { padding: 10px; background: #fff; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #eee; }
        .nav-link { border-radius: 12px; font-weight: 700; color: #888; padding: 12px; transition: 0.2s; }
        .nav-link.active { background-color: #333; color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* ìë£Œì‹¤ & ì¬ë£Œ ì¹´ë“œ */
        .list-container { padding: 15px; }
        .item-card { 
            background: #fff; border: 1px solid #e0e0e0; padding: 15px; border-radius: 12px; 
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer; transition: 0.1s;
        }
        .item-card:active { transform: scale(0.98); background: #f8f9fa; }
        
        .item-name { font-weight: 700; font-size: 1rem; color: #333; margin-bottom: 2px; }
        .item-sub { font-size: 0.8rem; color: #888; }
        .badge-price { background: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; }
        .badge-no-price { background: #fff3e0; color: #ef6c00; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; }

        /* í•˜ë‹¨ ê³ ì • ë ˆì‹œí”¼ ë°” */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            padding: 15px; border-top: 1px solid #ddd; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center; max-width: 600px; margin: 0 auto;
        }
        .total-price { font-size: 1.5rem; font-weight: 900; color: #d32f2f; }
        
        /* ëª¨ë‹¬ (ì¬ë£Œ ì„ íƒ ì‹œ ëœ¨ëŠ” ì°½) */
        .modal-body-custom { padding: 20px; text-align: center; }
        .amount-input { font-size: 2rem; text-align: center; font-weight: bold; border: none; border-bottom: 2px solid #333; width: 150px; margin: 20px 0; }
        .amount-input:focus { outline: none; border-color: #198754; }

        .d-none { display: none !important; }
    </style>
</head>
<body>

<div class="main-container">
    <ul class="nav nav-pills nav-fill">
        <li class="nav-item"><a class="nav-link active" id="tab-drive" onclick="setTab('drive')">â˜ï¸ ìë£Œì‹¤</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-calc" onclick="setTab('calc')">ğŸ’° ì›ê°€ê³„ì‚°</a></li>
    </ul>

    <div id="view-drive" class="list-container">
        <input type="text" id="searchDrive" class="form-control mb-3 p-3 rounded-pill" placeholder="ğŸ” ì±…/ì˜ìƒ ì œëª© ê²€ìƒ‰..." onkeyup="filterDrive()">
        <div id="driveList"></div>
    </div>

    <div id="view-calc" class="list-container d-none">
        <div id="recipeBox" class="bg-light p-3 rounded-3 mb-3 d-none">
            <h6 class="fw-bold small text-muted mb-2">í˜„ì¬ ë ˆì‹œí”¼</h6>
            <div id="recipeList"></div>
        </div>

        <input type="text" id="searchIng" class="form-control mb-3 p-3 rounded-pill" placeholder="ğŸ” ì¬ë£Œ ì´ë¦„ (ì˜ˆ: ì–‘íŒŒ, ì†Œê³ ê¸°)..." onkeyup="filterIng()">
        
        <div id="ingList">
            <div class="text-center py-5 text-muted">
                <div class="spinner-border text-success mb-2"></div>
                <p>ì¬ë£Œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>
</div>

<div id="bottomBar" class="bottom-bar d-none">
    <span class="small text-muted fw-bold">ì´ ì˜ˆìƒ ì›ê°€</span>
    <span class="total-price" id="grandTotal">0ì›</span>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body modal-body-custom">
                <h5 class="fw-bold mb-1" id="modalIngName">ì¬ë£Œëª…</h5>
                <p class="small text-muted" id="modalIngInfo">ë‹¨ê°€ ì •ë³´</p>
                
                <input type="number" id="modalAmount" class="amount-input" placeholder="0" inputmode="numeric">
                <div class="text-muted small mb-3">g (ê·¸ë¨)</div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-dark btn-lg fw-bold" onclick="confirmAdd()">ì¶”ê°€í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let driveFiles = [];
    let ingredients = [];
    let recipe = [];
    let selectedIng = null;
    let addModal = null;

    // íƒ­ ì „í™˜
    function setTab(mode) {
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');
        
        if(mode === 'drive') {
            document.getElementById('view-drive').classList.remove('d-none');
            document.getElementById('view-calc').classList.add('d-none');
            document.getElementById('bottomBar').classList.add('d-none');
        } else {
            document.getElementById('view-drive').classList.add('d-none');
            document.getElementById('view-calc').classList.remove('d-none');
            document.getElementById('bottomBar').classList.remove('d-none');
            loadIngredients(); // íƒ­ ëˆ„ë¥´ë©´ ë¡œë”©
        }
    }

    // ============ [1] ìë£Œì‹¤ ë¡œì§ ============
    fetch('/api/files').then(r=>r.json()).then(data => {
        driveFiles = data;
        filterDrive();
    });

    function filterDrive() {
        const q = document.getElementById('searchDrive').value.toLowerCase();
        const box = document.getElementById('driveList');
        
        if(!q) { box.innerHTML = '<p class="text-center text-muted mt-5">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>'; return; }

        let html = '';
        driveFiles.filter(f => f.name.toLowerCase().includes(q)).forEach(f => {
            html += `<div class="item-card" onclick="window.open('/download/${f.path}')">
                <div>
                    <div class="item-name">${f.name}</div>
                    <div class="item-sub">${f.folder}</div>
                </div>
                <i class="fas fa-chevron-right text-muted"></i>
            </div>`;
        });
        box.innerHTML = html || '<p class="text-center text-muted">ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    }

    // ============ [2] ì›ê°€ê³„ì‚° ë¡œì§ ============
    function loadIngredients() {
        if(ingredients.length > 0) return; // ì´ë¯¸ ë¡œë”©í–ˆìœ¼ë©´ íŒ¨ìŠ¤

        fetch('/api/ingredients')
            .then(res => res.json())
            .then(data => {
                if(data.error) {
                    document.getElementById('ingList').innerHTML = `<p class="text-danger text-center mt-5">${data.error}</p>`;
                } else {
                    ingredients = data;
                    renderIngList(ingredients);
                }
            })
            .catch(err => {
                document.getElementById('ingList').innerHTML = `<p class="text-danger text-center">ì—°ê²° ì‹¤íŒ¨: ${err}</p>`;
            });
    }

    function renderIngList(list) {
        const box = document.getElementById('ingList');
        if(list.length === 0) { box.innerHTML = '<p class="text-center text-muted mt-5">ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }

        let html = '';
        list.slice(0, 100).forEach((ing, idx) => { // ë„ˆë¬´ ë§ìœ¼ë©´ 100ê°œë§Œ ë¨¼ì € í‘œì‹œ
            let priceTag = ing.price > 0 ? 
                `<span class="badge-price">${parseInt(ing.price).toLocaleString()}ì›</span>` : 
                `<span class="badge-no-price">ê°€ê²©ë¯¸ì •</span>`;
            
            // ë°ì´í„° ì†ì„±ìœ¼ë¡œ ì¸ë±ìŠ¤ ì €ì¥
            html += `
            <div class="item-card" onclick="openAddModal(${idx})">
                <div>
                    <div class="item-name">${ing.name}</div>
                    <div class="item-sub">${ing.spec}</div>
                </div>
                ${priceTag}
            </div>`;
        });
        box.innerHTML = html;
    }

    function filterIng() {
        const q = document.getElementById('searchIng').value.toLowerCase();
        const filtered = ingredients.filter(i => i.name.toLowerCase().includes(q));
        renderIngList(filtered);
    }

    // --- ì¶”ê°€ íŒì—… ê´€ë ¨ ---
    function openAddModal(idx) {
        // ê²€ìƒ‰ëœ ë¦¬ìŠ¤íŠ¸ ê¸°ì¤€ì´ ì•„ë‹ˆë¼ ì „ì²´ ë¦¬ìŠ¤íŠ¸ ê¸°ì¤€ì´ì–´ì•¼ í•¨.
        // í˜„ì¬ í™”ë©´ì— ê·¸ë ¤ì§„ ê±´ filteredì¼ ìˆ˜ ìˆìœ¼ë‹ˆ, nameìœ¼ë¡œ ì°¾ê±°ë‚˜.. 
        // ê°„ë‹¨íˆ: ë Œë”ë§ í•  ë•Œ idxëŠ” ì›ë³¸ ë°°ì—´ì˜ idxë¥¼ ì“°ë©´ ë¨? 
        // -> ì•„ë‹˜. ë Œë”ë§ ì‹œ idxëŠ” ê·¸ëƒ¥ ë£¨í”„ ìˆœì„œì„.
        // í•´ê²°: í•„í„°ë§ ë  ë•Œ ì›ë³¸ ê°ì²´ë¥¼ ë„˜ê¸°ë¯€ë¡œ, onclickì— ê°ì²´ ì •ë³´ë¥¼ ë„£ëŠ” ê±´ ë³µì¡.
        // ì´ë¦„ì„ ê¸°ì¤€ìœ¼ë¡œ ì°¾ê² ìŠµë‹ˆë‹¤. (ì¤‘ë³µì´ ì—†ë‹¤ê³  ê°€ì •)
        
        const cardName = document.querySelectorAll('.item-card .item-name')[idx].innerText;
        selectedIng = ingredients.find(i => i.name === cardName);

        if(!selectedIng) return;

        document.getElementById('modalIngName').innerText = selectedIng.name;
        document.getElementById('modalIngInfo').innerText = selectedIng.price > 0 ? 
            `${parseInt(selectedIng.price)}ì› / ${selectedIng.spec}` : "ê°€ê²© ì •ë³´ ì—†ìŒ";
        
        document.getElementById('modalAmount').value = '';
        
        if(!addModal) addModal = new bootstrap.Modal(document.getElementById('addModal'));
        addModal.show();
        
        setTimeout(() => document.getElementById('modalAmount').focus(), 500);
    }

    function confirmAdd() {
        const amount = document.getElementById('modalAmount').value;
        if(!amount) { alert("ëª‡ ê·¸ë¨(g)ì¸ì§€ ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }

        const cost = Math.round(selectedIng.price_per_g * amount);
        
        recipe.push({ ...selectedIng, amount: amount, totalCost: cost });
        updateRecipeUI();
        
        addModal.hide();
        document.getElementById('searchIng').value = ''; // ê²€ìƒ‰ ì´ˆê¸°í™”
        filterIng(); // ëª©ë¡ ë‹¤ì‹œ ì „ì²´ ë³´ì´ê¸°
    }

    function updateRecipeUI() {
        const box = document.getElementById('recipeList');
        const container = document.getElementById('recipeBox');
        
        if(recipe.length > 0) container.classList.remove('d-none');
        else container.classList.add('d-none');

        let html = '';
        let grandTotal = 0;

        recipe.forEach((item, idx) => {
            grandTotal += item.totalCost;
            html += `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <div>
                    <span class="fw-bold">${item.name}</span> 
                    <small class="text-muted ms-1">${item.amount}g</small>
                </div>
                <div>
                    <span class="fw-bold text-dark me-2">${item.totalCost.toLocaleString()}ì›</span>
                    <i class="fas fa-minus-circle text-danger" onclick="removeRecipe(${idx})"></i>
                </div>
            </div>`;
        });
        
        box.innerHTML = html;
        document.getElementById('grandTotal').innerText = grandTotal.toLocaleString() + "ì›";
    }

    function removeRecipe(idx) {
        recipe.splice(idx, 1);
        updateRecipeUI();
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHEF DSKIM SYSTEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        
        :root {
            --primary: #4f46e5;
            --bg: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: var(--bg); color: var(--text); }
        
        #root-container { display: flex; flex-direction: column; height: 100vh; padding-bottom: 70px; }
        .workspace { display: none; flex-direction: column; height: 100%; overflow-y: auto; background: var(--bg); }
        
        .app-header { background: var(--white); px-4; py-3; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .header-title { font-size: 20px; font-weight: 900; font-style: italic; tracking-tighter; display: flex; align-items: center; gap: 10px; }
        .back-btn { font-size: 24px; cursor: pointer; color: #94a3b8; }
        
        .main-hero { height: 160px; background: linear-gradient(rgba(79, 70, 229, 0.85), rgba(79, 70, 229, 0.85)), url('https://images.unsplash.com/photo-1556910103-1c02745a30bf') center/cover; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .hero-title { font-size: 26px; font-weight: 900; font-style: italic; margin: 0; }
        .grid-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px 10px; background: white; padding: 25px 15px; border-bottom: 1px solid var(--border); }
        .grid-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .grid-icon { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .grid-text { font-size: 11px; font-weight: 700; color: #475569; }

        .search-container { padding: 15px; background: white; border-bottom: 1px solid var(--border); }
        .search-box { display: flex; gap: 10px; }
        .search-input { flex: 1; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 14px; font-weight: 700; outline: none; transition: all 0.2s; }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .search-btn { background: var(--primary); color: white; padding: 0 20px; border-radius: 12px; font-weight: 900; font-size: 14px; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        
        .category-wrapper { max-height: 200px; overflow-y: auto; padding: 15px; background: white; margin-bottom: 10px; }
        .cat-title { font-size: 11px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; margin-top: 12px; }
        .cat-title:first-child { margin-top: 0; }
        .tag-group { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag-btn { background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; }
        .tag-btn:active, .tag-btn.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; font-weight: 900; }

        .recipe-list-area { padding: 10px 15px 30px 15px; }
        .recipe-card { background: white; border: 1px solid var(--border); border-radius: 16px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; }
        .recipe-card-head { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .recipe-card-head:active { background: #f8fafc; }
        .recipe-title { font-size: 16px; font-weight: 900; color: #1e293b; }
        .recipe-badge { display: inline-block; background: #eff6ff; color: #2563eb; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; border: 1px solid #bfdbfe; margin-left: 10px; vertical-align: middle; }
        .recipe-card-body { display: none; padding: 0 16px 16px 16px; background: white; }
        .recipe-card.open .recipe-card-body { display: block; border-top: 1px dashed #e2e8f0; padding-top: 16px; }
        
        .detail-section { margin-bottom: 16px; }
        .detail-label { font-size: 10px; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .detail-content-box { background: #f8fafc; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 13px; font-weight: 600; color: #334155; white-space: pre-wrap; line-height: 1.6; }
        
        .recipe-img-box { width: 100px; height: 100px; flex-shrink: 0; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; background: #f1f5f9; }
        .recipe-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s; }
        .recipe-img:active { transform: scale(1.05); }
        .recipe-img-empty { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; color: #4f46e5; text-align: center; text-decoration: underline; background: #eef2ff; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; width: 60px; height: 50px; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .nav-item.active { color: var(--primary); background: #eef2ff; font-weight: 900; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; }
        .nav-text { font-size: 10px; font-weight: 700; }
        
        .loading-text { text-align: center; padding: 40px; font-size: 14px; font-weight: 700; color: #94a3b8; }
    </style>
</head>
<body>

    <div id="root-container">
        <div id="main-view" class="workspace" style="display: flex;">
            <div class="main-hero">
                <h1 class="hero-title">CHEF DSKIM</h1>
                <div class="text-xs font-bold opacity-80 mt-1 uppercase tracking-widest">Smart Kitchen System</div>
            </div>
            <div class="container mx-auto">
                <div class="grid-menu">
                    <div class="grid-item" onclick="openModule('100')"><div class="grid-icon" style="background:#f59e0b"><i class="fas fa-book-open"></i></div><span class="grid-text">레시피</span></div>
                    <div class="grid-item" onclick="openModule('400')"><div class="grid-icon" style="background:#8b5cf6"><i class="fas fa-flask"></i></div><span class="grid-text">연구노트</span></div>
                    <div class="grid-item" onclick="openModule('010')"><div class="grid-icon" style="background:#334155"><i class="fas fa-boxes"></i></div><span class="grid-text">자산재고</span></div>
                    <div class="grid-item" onclick="openModule('020')"><div class="grid-icon" style="background:#ef4444"><i class="fas fa-chart-pie"></i></div><span class="grid-text">손익관리</span></div>
                    <div class="grid-item" onclick="openModule('030')"><div class="grid-icon" style="background:#10b981"><i class="fas fa-graduation-cap"></i></div><span class="grid-text">직원교육</span></div>
                    <div class="grid-item" onclick="openModule('900')"><div class="grid-icon" style="background:#3b82f6"><i class="fas fa-cloud"></i></div><span class="grid-text">자료실</span></div>
                    <div class="grid-item" onclick="openModule('500')"><div class="grid-icon" style="background:#f97316"><i class="fas fa-calendar-check"></i></div><span class="grid-text">일정</span></div>
                    <div class="grid-item" onclick="openModule('600')"><div class="grid-icon" style="background:#64748b"><i class="fas fa-bullhorn"></i></div><span class="grid-text">공지</span></div>
                </div>
            </div>
        </div>

        <div id="workspace-100" class="workspace">
            <header class="app-header">
                <div class="header-title">
                    <i class="fas fa-chevron-left back-btn" onclick="goMain()"></i>
                    <span>Recipe Master</span>
                </div>
            </header>
            
            <div class="search-container shadow-sm">
                <div class="search-box">
                    <input type="text" id="recipeInput" class="search-input" placeholder="메뉴 검색 (예: 닭갈비, KOR)">
                    <button class="search-btn" onclick="loadRecipe(document.getElementById('recipeInput').value)">GO</button>
                </div>
            </div>

            <div class="category-wrapper border-b">
                <div class="cat-title">국가/대륙별</div>
                <div class="tag-group">
                    <div class="tag-btn" onclick="loadRecipe('KOR')">KOR</div>
                    <div class="tag-btn" onclick="loadRecipe('JAP')">JAP</div>
                    <div class="tag-btn" onclick="loadRecipe('WST')">WST</div>
                    <div class="tag-btn" onclick="loadRecipe('CHN')">CHN</div>
                    <div class="tag-btn" onclick="loadRecipe('SEA')">SEA</div>
                    <div class="tag-btn" onclick="loadRecipe('ETC')">ETC</div>
                </div>
                <div class="cat-title">식재료별</div>
                <div class="tag-group">
                    <div class="tag-btn" onclick="loadRecipe('육류')">육류</div>
                    <div class="tag-btn" onclick="loadRecipe('가금류')">가금류</div>
                    <div class="tag-btn" onclick="loadRecipe('해산물')">해산물</div>
                    <div class="tag-btn" onclick="loadRecipe('채소')">채소</div>
                    <div class="tag-btn" onclick="loadRecipe('버섯')">버섯류</div>
                    <div class="tag-btn" onclick="loadRecipe('해조류')">해조류</div>
                    <div class="tag-btn" onclick="loadRecipe('과일')">과일</div>
                    <div class="tag-btn" onclick="loadRecipe('콩/견과')">콩/견과</div>
                </div>
                <div class="cat-title">조리법별</div>
                <div class="tag-group">
                    <div class="tag-btn" onclick="loadRecipe('밥')">밥</div><div class="tag-btn" onclick="loadRecipe('죽')">죽</div>
                    <div class="tag-btn" onclick="loadRecipe('면')">면/수제비</div><div class="tag-btn" onclick="loadRecipe('만두')">만두</div>
                    <div class="tag-btn" onclick="loadRecipe('국')">국</div><div class="tag-btn" onclick="loadRecipe('찌개')">찌개/전골</div>
                    <div class="tag-btn" onclick="loadRecipe('김치')">김치/나물</div><div class="tag-btn" onclick="loadRecipe('구이')">구이</div>
                    <div class="tag-btn" onclick="loadRecipe('조림')">조림/지짐</div><div class="tag-btn" onclick="loadRecipe('볶음')">볶음/초</div>
                    <div class="tag-btn" onclick="loadRecipe('전')">전/적</div><div class="tag-btn" onclick="loadRecipe('찜')">찜/선</div>
                    <div class="tag-btn" onclick="loadRecipe('회')">회</div><div class="tag-btn" onclick="loadRecipe('마른반찬')">마른반찬</div>
                    <div class="tag-btn" onclick="loadRecipe('수육')">수육/편육</div><div class="tag-btn" onclick="loadRecipe('장아찌')">장아찌/젓갈</div>
                    <div class="tag-btn" onclick="loadRecipe('장')">장</div><div class="tag-btn" onclick="loadRecipe('디저트')">떡/디저트</div>
                </div>
            </div>

            <div id="recipe-list" class="recipe-list-area flex-1 bg-slate-50">
                <div class="loading-text">위에서 카테고리를 선택하거나<br>검색어를 입력하세요.</div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="goMain()"><i class="fas fa-home nav-icon"></i><span class="nav-text">HOME</span></div>
            <div class="nav-item" onclick="openModule('100')"><i class="fas fa-book nav-icon"></i><span class="nav-text">RECIPE</span></div>
            <div class="nav-item" onclick="openModule('400')"><i class="fas fa-flask nav-icon"></i><span class="nav-text">R&D</span></div>
            <div class="nav-item" onclick="openModule('900')"><i class="fas fa-folder nav-icon"></i><span class="nav-text">FILE</span></div>
            <div class="nav-item" onclick="openModule('010')"><i class="fas fa-chart-pie nav-icon"></i><span class="nav-text">MNG</span></div>
        </nav>

    </div>

    <div id="workspace-010" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>자산관리</span></div></div></div>
    <div id="workspace-020" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>손익관리</span></div></div></div>
    <div id="workspace-400" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>연구노트</span></div></div></div>
    <div id="workspace-030" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>직원교육</span></div></div></div>
    <div id="workspace-900" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>자료실</span></div></div></div>
    <div id="workspace-500" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>일정관리</span></div></div></div>
    <div id="workspace-600" class="workspace" style="display:none;"><div class="app-header"><div class="header-title"><i class="fas fa-chevron-left back-btn" onclick="goMain()"></i><span>공지사항</span></div></div></div>

    <script>
        const gasUrl = "https://script.google.com/macros/s/AKfycbwtNgSrgkjEiaJm4bPIXjddIlU19IYUCgZvx6WIRPLCCar7QndBmiEG-EIaRk3yXLUa/exec";
        
        function goMain() { 
            document.querySelectorAll('.workspace').forEach(e=>e.style.display='none'); 
            document.getElementById('main-view').style.display='flex'; 
            window.scrollTo(0,0); 
            updateNav('HOME'); 
        }

        function openModule(code) {
            document.querySelectorAll('.workspace').forEach(e=>e.style.display='none');
            const ws = document.getElementById('workspace-'+code);
            if(ws) ws.style.display='flex';
            
            if(code==='100') {
                document.getElementById('recipeInput').value = "";
                document.getElementById('recipe-list').innerHTML = "<div class='loading-text'>위에서 카테고리를 선택하거나<br>검색어를 입력하세요.</div>";
                updateNav('RECIPE');
            } else if(code==='400') updateNav('R&D');
            else if(code==='900') updateNav('FILE');
            else if(code==='010' || code==='020') updateNav('MNG');
            else updateNav('HOME');
        }

        function updateNav(txt){ 
            document.querySelectorAll('.nav-item').forEach(b=>{ 
                b.classList.remove('active'); 
                if(b.querySelector('.nav-text').innerText === txt) b.classList.add('active'); 
            }); 
        }

        /* --- [100] 레시피: uc?export 방식 및 안전 버튼 복구 --- */
        document.getElementById('recipeInput').addEventListener('keypress', e => { 
            if(e.key==='Enter') loadRecipe(document.getElementById('recipeInput').value); 
        });

        function loadRecipe(keywordStr) {
            const area = document.getElementById('recipe-list');
            area.innerHTML = "<div class='loading-text'><i class='fas fa-spinner fa-spin text-2xl mb-2 text-indigo-500'></i><br>데이터를 불러오는 중입니다...</div>";
            
            document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
            if(event && event.target && event.target.classList) event.target.classList.add('active');

            fetch(`${gasUrl}?action=recipe&keyword=${encodeURIComponent(keywordStr)}`)
            .then(r=>r.json())
            .then(l => {
                let h = "";
                l.forEach((i, idx) => {
                    let imgHtml = `<div class="recipe-img-empty">NO IMAGE</div>`;
                    if (i.img && i.img.includes("http")) {
                        let src = i.img;
                        let link = i.img;
                        if (src.includes("drive.google.com")) { 
                            let m = src.match(/[-\w]{25,}/); 
                            if(m) {
                                // 가장 안정적인 uc?export 방식 사용
                                src = `https://drive.google.com/uc?export=view&id=${m[0]}`; 
                                link = `https://drive.google.com/file/d/${m[0]}/view`;
                            }
                        }
                        // 이미지가 안 뜨면 엑박이나 권한오류 대신 예쁜 '터치해서 사진보기' 파란색 버튼으로 변신
                        imgHtml = `<div class="recipe-img-box" onclick="window.open('${link}', '_blank')">
                                     <img src="${src}" class="recipe-img" onerror="this.parentElement.innerHTML='<div class=\\'recipe-img-empty\\'>사진 차단됨<br>(터치해서 보기)</div>'">
                                   </div>`;
                    }
                    
                    let dStr = i.details.map(d => {
                        let txt = d.text;
                        let driveMatch = txt.match(/https:\/\/drive\.google\.com[^\s"']+/);
                        
                        if (driveMatch) {
                            let m = driveMatch[0].match(/[-\w]{25,}/);
                            if (m) {
                                let viewSrc = `https://drive.google.com/uc?export=view&id=${m[0]}`;
                                let orgLink = `https://drive.google.com/file/d/${m[0]}/view`;
                                txt = txt.replace(driveMatch[0], `
                                    <div class="mt-3 cursor-pointer border rounded-xl overflow-hidden shadow-sm" onclick="window.open('${orgLink}', '_blank')">
                                        <img src="${viewSrc}" style="width:100%;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div class="bg-indigo-50 text-indigo-600 text-center text-xs font-bold py-3" style="display:none;">사진이 브라우저에 의해 차단되었습니다.<br>이곳을 눌러 원본을 확인하세요.</div>
                                    </div>
                                `);
                            }
                        } else if(txt.includes("http")) {
                            txt = txt.replace(/(https?:\/\/[^\s]+)/g, `<a href="$1" target="_blank" class="text-blue-500 underline font-bold">[링크 바로가기]</a>`);
                        }

                        return `
                            <div class="detail-section">
                                <div class="detail-label">${d.cat}</div>
                                <div class="detail-content-box">${txt}</div>
                            </div>
                        `;
                    }).join("");

                    h += `
                        <div class="recipe-card" onclick="this.classList.toggle('open')">
                            <div class="recipe-card-head">
                                <div>
                                    <span class="recipe-title">${i.name}</span> 
                                    <span class="recipe-badge">${i.type}</span>
                                </div>
                                <i class="fas fa-chevron-down text-slate-300"></i>
                            </div>
                            <div class="recipe-card-body" onclick="event.stopPropagation()">
                                <div class="flex gap-4 items-start mb-4">
                                    ${imgHtml}
                                    <div class="flex-1">
                                        <div class="text-xs font-bold text-slate-500 mb-1">상세 레시피 정보</div>
                                        <div class="text-[10px] text-slate-400 leading-tight">사진이나 텍스트 내부의 이미지를<br>터치하면 원본이 열립니다.</div>
                                    </div>
                                </div>
                                ${dStr}
                            </div>
                        </div>
                    `;
                });
                area.innerHTML = l.length ? h : "<div class='loading-text'>검색 결과가 없습니다.</div>";
            }).catch(e => {
                area.innerHTML = "<div class='loading-text text-red-500'>데이터를 불러오는 중 오류가 발생했습니다.</div>";
            });
        }
    </script>
</body>
</html>

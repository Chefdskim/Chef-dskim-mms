<script>
        const gasUrl = "https://script.google.com/macros/s/AKfycbwtNgSrgkjEiaJm4bPIXjddIlU19IYUCgZvx6WIRPLCCar7QndBmiEG-EIaRk3yXLUa/exec";
        
        // ì…°í”„ë‹˜ì˜ ì„¤ë¬¸ì§€ ì£¼ì†Œ
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSejJy628hEvS5_0QpukHJsFJF228YCEBgW0W6BDutfpjm-UDQ/viewform"; 

        function toggleSubMenu() { const el = document.getElementById('submenu-000'); el.style.display = (el.style.display==='block')?'none':'block'; }
        function goBackMain() { document.querySelectorAll('.workspace').forEach(el=>el.style.display='none'); document.getElementById('main-nav').style.display='block'; document.getElementById('page-title').innerText="MAIN MENU"; }
        
        function openModule(code) {
            document.getElementById('main-nav').style.display='none'; document.querySelectorAll('.workspace').forEach(el=>el.style.display='none');
            const titles = {'010':'010 ìì‚°/ì¬ê³ ', '020':'020 ì†ìµ/ì›ê°€', '030':'030 ì§ì›êµìœ¡', '100':'100~300 ë ˆì‹œí”¼', '400':'400 ì‹¬í™” ì—°êµ¬'};
            document.getElementById('page-title').innerText = titles[code];
            if(code==='010'){document.getElementById('workspace-010').style.display='block'; loadAsset(); setMode('in');}
            else if(code==='020'){document.getElementById('workspace-020').style.display='block'; loadBEP(); loadMenuCost();}
            else if(code==='030'){document.getElementById('workspace-030').style.display='block'; loadManual();}
            else if(code==='100'){document.getElementById('workspace-100').style.display='block'; loadRecipe();}
            else if(code==='400'){
                document.getElementById('workspace-400').style.display='block'; 
                // iFrame ì£¼ì†Œ ì£¼ì…
                document.getElementById('google-form-frame').src = formUrl;
                loadRnD();
            }
        }

        // [400] R&D Logic (ê°•ë ¥í•œ ì‚¬ì§„ ID ì¶”ì¶œê¸° íƒ‘ì¬)
        function openForm() { window.open(formUrl, '_blank'); }
        
        function loadRnD() {
            const area = document.getElementById('rnd-list-area');
            area.innerHTML = "<p style='text-align:center; color:#999'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
            
            fetch(`${gasUrl}?action=rnd`).then(r => r.json()).then(l => {
                if(l.length === 0) { area.innerHTML = "<p style='text-align:center; color:#999'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ ì„¤ë¬¸ì§€ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>"; return; }
                
                let html = "";
                l.forEach(i => {
                    let c = "#777";
                    if(i.status && i.status.includes("ì•„ì´ë””ì–´")) c = "#f39c12";
                    if(i.status && i.status.includes("í…ŒìŠ¤íŠ¸")) c = "#e74c3c";
                    if(i.status && i.status.includes("ì„±ê³µ")) c = "#27ae60";

                    // [í•µì‹¬] ì‚¬ì§„ ì£¼ì†Œ ì²˜ë¦¬ (ì–´ë–¤ ëª¨ì–‘ì´ë“  ë‹¤ ì¡ì•„ëƒ„)
                    let imgHtml = "";
                    if (i.photo && i.photo.trim() !== "") {
                        try {
                            let fileId = "";
                            let rawUrl = i.photo.toString();

                            // Case 1: id=xxxxx í˜•íƒœ
                            if (rawUrl.includes("id=")) {
                                fileId = rawUrl.split("id=")[1].split("&")[0].split(",")[0];
                            } 
                            // Case 2: /d/xxxxx/ í˜•íƒœ
                            else if (rawUrl.includes("/d/")) {
                                fileId = rawUrl.split("/d/")[1].split("/")[0];
                            }

                            if (fileId) {
                                // 1. ë¯¸ë¦¬ë³´ê¸°ìš© ì¸ë„¤ì¼ ì£¼ì†Œ
                                let thumbUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                                
                                imgHtml = `<div style="margin-top:10px; text-align:center; background:#f9f9f9; padding:5px; border-radius:8px;">
                                     <img src="${thumbUrl}" style="width:100%; max-width:250px; border-radius:4px; display:block; margin:0 auto;" referrerpolicy="no-referrer">
                                     <div style="margin-top:5px;">
                                        <a href="${thumbUrl}" target="_blank" class="photo-link-btn">ğŸ” í¬ê²Œ ë³´ê¸°</a>
                                     </div>
                                   </div>`;
                            } else {
                                // ID ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ë§í¬ë¼ë„ ë„ì›€
                                imgHtml = `<div style="margin-top:5px;"><a href="${rawUrl}" target="_blank" class="photo-link-btn">ğŸ“· ì‚¬ì§„ ë§í¬ ì—´ê¸°</a></div>`;
                            }
                        } catch(e) { console.log("ì´ë¯¸ì§€ ì—ëŸ¬", e); }
                    }

                    // ìˆ˜ì • ë²„íŠ¼ í¬í•¨
                    html += `<div class="info-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; font-size:16px;">${i.menu}</span>
                            <div>
                                <span style="font-size:11px; font-weight:bold; color:${c}; border:1px solid ${c}; padding:2px 6px; border-radius:4px; margin-right:5px;">${i.status}</span>
                                <button onclick='openEditModal(${JSON.stringify(i)})' style="font-size:11px; padding:2px 6px; cursor:pointer;">âœï¸ ìˆ˜ì •</button>
                            </div>
                        </div>
                        <div style="font-size:12px; color:#999; margin-bottom:10px;">${i.date}</div>
                        <p style="font-size:14px; color:#333; white-space:pre-wrap;">${i.note}</p>
                        ${imgHtml}
                    </div>`;
                });
                area.innerHTML = html;
            });
        }

        // ìˆ˜ì • íŒì—… ê´€ë ¨ í•¨ìˆ˜
        function openEditModal(item) {
            document.getElementById('edit-row').value = item.row;
            document.getElementById('edit-menu').value = item.menu;
            document.getElementById('edit-status').value = item.status;
            document.getElementById('edit-note').value = item.note;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
        
        function submitEdit() {
            const item = {
                row: document.getElementById('edit-row').value,
                menu: document.getElementById('edit-menu').value,
                status: document.getElementById('edit-status').value,
                note: document.getElementById('edit-note').value
            };
            const btn = document.querySelector('#edit-modal button:last-child');
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;

            google.script.run.withSuccessHandler(function(res) {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeEditModal();
                btn.innerText = "ìˆ˜ì • ì €ì¥"; btn.disabled = false;
                loadRnD(); 
            }).updateRnDItem(item);
        }

        // [010~100] ê³µí†µ ë¡œì§
        function loadRecipe(){const k=document.getElementById('recipeInput').value;const a=document.getElementById('recipe-list-area');a.innerHTML="<p style='text-align:center;color:#999'>ë¡œë”© ì¤‘...</p>";fetch(`${gasUrl}?action=recipe&keyword=${encodeURIComponent(k)}`).then(r=>r.json()).then(l=>{if(l.length===0){a.innerHTML="<p style='text-align:center;color:#999'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>";return;}let h="";l.forEach(i=>{let g={};i.details.forEach(d=>{if(!g[d.section])g[d.section]=[];g[d.section].push(d)});let b="";for(let s in g){if(!s)continue;let r="";g[s].forEach(row=>{let v=row.video?`<a href="${row.video}" target="_blank" class="video-btn">â–¶ ì˜ìƒ</a>`:"";r+=`<div class="detail-row"><div class="detail-cat">${row.category}</div><div class="detail-content">${row.content}${v}</div></div>`});b+=`<div class="section-block"><div class="section-title">${s}</div>${r}</div>`}h+=`<div class="recipe-card"><div class="recipe-header"><span class="recipe-title">${i.name}</span><span class="recipe-type">${i.type}</span></div><div class="recipe-body">${b}</div></div>`});a.innerHTML=h})}
        let currentMode='in'; let workList=[];
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('searchBtn').addEventListener('click', ()=>{ const v=document.getElementById('searchInput').value; fetch(`${gasUrl}?action=search&item=${v}`).then(r=>r.json()).then(d=>{ let h=""; d.forEach(i=>{h+=`<div style="padding:10px;border-bottom:1px solid #eee;"><b>${i.name}</b> <button class="action-btn" onclick="addToList('${i.name}','${i.spec}','${i.unit}')" style="float:right;padding:5px 10px;">ì¶”ê°€</button></div>`}); document.getElementById('result-list').innerHTML=h; }); });
            document.getElementById('recipeInput').addEventListener('keypress',e=>{if(e.key==='Enter')loadRecipe();});
        });
        function loadAsset(){fetch(`${gasUrl}?action=asset`).then(r=>r.json()).then(d=>document.getElementById('asset-value').innerText=Number(d.total).toLocaleString()+" ì›")}
        function loadBEP(){fetch(`${gasUrl}?action=bep`).then(r=>r.json()).then(d=>{document.getElementById('fin-current').innerText=Number(d.current).toLocaleString();const p=document.getElementById('fin-profit');p.innerText=Number(d.netProfit).toLocaleString();p.className=d.netProfit>0?"finance-val finance-profit plus":"finance-val finance-profit"})}
        function loadMenuCost(){fetch(`${gasUrl}?action=menu_cost`).then(r=>r.json()).then(l=>{let h="";l.forEach(i=>{let c=i.ratio>35?"cost-bad":"cost-good";h+=`<div class="menu-card"><div><b>${i.name}</b><br><small>${Number(i.cost).toLocaleString()}/${Number(i.price).toLocaleString()}</small></div><div class="cost-badge ${c}">${i.ratio}%</div></div>`});document.getElementById('menu-list-area').innerHTML=h})}
        function loadManual(){fetch(`${gasUrl}?action=manual`).then(r=>r.json()).then(l=>{let h="";l.forEach(i=>{let link=i.link?`<a href="${i.link}" target="_blank">ğŸ”— ì˜ìƒ</a>`:"";h+=`<div class="info-card"><b>${i.title}</b><br><small>${i.category}</small><p>${i.content}</p>${link}</div>`});document.getElementById('manual-list-area').innerHTML=h})}
        function loadStock(){setMode('stock');fetch(`${gasUrl}?action=inventory`).then(r=>r.json()).then(d=>{let h='<table>';d.forEach(i=>{h+=`<tr><td>${i.name}</td><td>${i.qty}</td></tr>`});document.getElementById('result-list').innerHTML=h+'</table>'})}
        function setMode(m){currentMode=m; document.getElementById('work-area').style.display=m==='stock'?'none':'block'; document.getElementById('search-area').style.display=m==='stock'?'none':'flex'; document.getElementById('result-list').innerHTML=""}
        function addToList(n,s,u){workList.push({date:new Date().toISOString().split('T')[0],name:n,spec:s,unit:u,qty:1}); renderList()}
        function saveToSheet(){fetch(`${gasUrl}?action=save&type=${currentMode}&data=${encodeURIComponent(JSON.stringify(workList))}`).then(()=>{alert("ì™„ë£Œ");workList=[];renderList()})}
    </script>

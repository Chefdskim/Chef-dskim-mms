<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef_dskim SYSTEM</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .main-btn { width: 100%; padding: 20px; margin-bottom: 10px; font-size: 16px; font-weight: bold; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer; text-align: left; }
        .code-tag { color: #888; font-size: 12px; display: block; margin-bottom: 5px; }
        #submenu-000 { display: none; background: #f8f9fa; margin-top: -5px; margin-bottom: 15px; padding: 5px; border: 1px solid #ddd; border-top: none; }
        .sub-btn { width: 100%; padding: 15px; border: none; border-bottom: 1px solid #eee; background: none; text-align: left; cursor: pointer; font-size: 15px; }
        .workspace { display: none; }
        .back-btn { background: none; border: none; color: #555; margin-bottom:15px; cursor:pointer; }
        .info-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .photo-link-btn { display:inline-block; padding:5px 10px; background:#eee; color:#333; text-decoration:none; border-radius:4px; font-size:12px; margin-top:5px; border:1px solid #ccc; }
        .search-box { display: flex; gap: 5px; margin-bottom: 15px; }
        input[type="text"], textarea { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .action-btn { padding: 10px 20px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .recipe-card { background: white; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .recipe-header { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .recipe-title { font-size: 20px; font-weight: bold; }
        .recipe-type { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-size: 12px; }
        .recipe-body { padding: 15px; }
        .section-block { margin-bottom: 20px; }
        .section-title { font-size: 15px; font-weight: bold; color: #d35400; border-bottom: 2px solid #fce3cf; padding-bottom: 5px; margin-bottom: 10px; display: inline-block; }
        .detail-row { display: flex; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #eee; padding-bottom: 8px; align-items: flex-start; }
        .detail-cat { font-weight: bold; color: #555; width: 80px; flex-shrink: 0; font-size: 13px; margin-top: 2px; }
        .detail-content { flex: 1; line-height: 1.5; color: #333; white-space: pre-wrap; }
        .video-btn { display: inline-block; background: #ff0000; color: white; font-size: 11px; font-weight: bold; padding: 4px 8px; border-radius: 4px; text-decoration: none; margin-left: 8px; vertical-align: middle; }
        .mode-switch { display: flex; gap: 5px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; cursor: pointer; background: #fff; color: #777; font-size: 13px; }
        .mode-btn.active-in { background: #e8f8f5; border-color: #27ae60; color: #27ae60; }
        .finance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .finance-item { background: #f8f9fa; padding: 15px; text-align: center; border-radius: 8px; }
        .finance-val { font-size: 16px; font-weight: bold; margin-top:5px; }
        .finance-profit.plus { color: #27ae60; } .finance-profit { color: #e74c3c; }
        .menu-card { display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; }
        .cost-good { background:#e8f8f5; color:#27ae60; padding:3px 8px; border-radius:4px; font-size:12px; }
        .cost-bad { background:#fdedec; color:#e74c3c; padding:3px 8px; border-radius:4px; font-size:12px; }

        /* ìˆ˜ì • íŒì—… ìŠ¤íƒ€ì¼ */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-box { background:white; padding:20px; border-radius:8px; width:90%; max-width:400px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="page-title">MAIN MENU</h2>
        <div id="main-nav">
            <button class="main-btn" onclick="toggleSubMenu()"><span class="code-tag">000</span> ê¸°ì¤€ì •ë³´ (ADMIN) â–¼</button>
            <div id="submenu-000">
                <button class="sub-btn" onclick="openModule('010')">010 ìì‚°/ì¬ê³ </button>
                <button class="sub-btn" onclick="openModule('020')">020 ì†ìµ/ì›ê°€</button>
                <button class="sub-btn" onclick="openModule('030')">030 ì§ì›êµìœ¡</button>
            </div>
            <button class="main-btn" onclick="openModule('100')"><span class="code-tag">100~300</span> êµ­ê°€ë³„ ìš”ë¦¬ (ë ˆì‹œí”¼) ğŸ“–</button>
            <button class="main-btn" onclick="openModule('400')"><span class="code-tag">400</span> ì‹¬í™” ì—°êµ¬ (R&D) ğŸ”¬</button>
        </div>

        <div id="workspace-010" class="workspace">
            <button class="back-btn" onclick="goBackMain()">â—€ ë©”ì¸ìœ¼ë¡œ</button>
            <div class="info-card"><div style="font-size:13px; color:#3498db; font-weight:bold;">ğŸ’° í˜„ì¬ ì´ ì¬ê³  ìì‚°</div><div id="asset-value" style="font-size:24px; font-weight:bold;">0 ì›</div></div>
            <div class="mode-switch"><button id="btn-in" class="mode-btn active-in" onclick="setMode('in')">ğŸ“¥ ë§¤ì…</button><button id="btn-out" class="mode-btn" onclick="setMode('out')">ğŸ“¤ ì¶œê³ </button><button id="btn-stock" class="mode-btn" onclick="loadStock()">ğŸ“¦ ì¬ê³ </button></div>
            <div id="search-area" class="search-box"><input type="text" id="searchInput" placeholder="í’ˆëª©ëª…"><button class="action-btn" id="searchBtn">ê²€ìƒ‰</button></div>
            <div id="result-list"></div><div id="work-area" style="margin-top:20px; display:none;"><strong id="list-title">ğŸ“‹ ì‘ì—… ë¦¬ìŠ¤íŠ¸</strong><div id="saved-list"></div><button id="send-btn" class="action-btn" onclick="saveToSheet()" style="width:100%; margin-top:10px;">ì €ì¥í•˜ê¸°</button></div>
        </div>

        <div id="workspace-020" class="workspace">
            <button class="back-btn" onclick="goBackMain()">â—€ ë©”ì¸ìœ¼ë¡œ</button>
            <div class="finance-grid"><div class="finance-item"><div>ë§¤ì¶œ</div><div class="finance-val" id="fin-current">0</div></div><div class="finance-item"><div>ìˆœì´ìµ</div><div class="finance-val" id="fin-profit">0</div></div></div>
            <div style="margin-top:20px;"><h5>ğŸ” ë©”ë‰´ ì›ê°€</h5><div id="menu-list-area"></div></div>
        </div>

        <div id="workspace-030" class="workspace">
            <button class="back-btn" onclick="goBackMain()">â—€ ë©”ì¸ìœ¼ë¡œ</button><div id="manual-list-area"></div>
        </div>

        <div id="workspace-100" class="workspace">
            <button class="back-btn" onclick="goBackMain()">â—€ ë©”ì¸ìœ¼ë¡œ</button>
            <div class="search-box"><input type="text" id="recipeInput" placeholder="ë©”ë‰´ëª… ê²€ìƒ‰"><button class="action-btn" onclick="loadRecipe()">ê²€ìƒ‰</button></div>
            <div id="recipe-list-area"></div>
        </div>

        <div id="workspace-400" class="workspace">
            <button class="back-btn" onclick="goBackMain()">â—€ ë©”ì¸ìœ¼ë¡œ</button>
            
            <div class="info-card" style="padding:0; overflow:hidden;">
                <div style="background:#2980b9; color:white; padding:10px; font-weight:bold; text-align:center;">ğŸ“ ì—°êµ¬ ê¸°ë¡ ì…ë ¥ (ì„¤ë¬¸ì§€)</div>
                <iframe id="google-form-frame" style="width:100%; height:450px; border:none;"></iframe>
            </div>

            <div style="margin-top:20px; border-bottom:2px solid #eee; padding-bottom:10px; font-weight:bold; color:#555; display:flex; justify-content:space-between; align-items:center;">
                <span>ğŸ“‹ ì—°êµ¬ ê¸°ë¡ ëª©ë¡</span>
                <button onclick="loadRnD()" style="font-size:12px; padding:5px 10px; border:1px solid #ccc; background:white; border-radius:4px; cursor:pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="rnd-list-area"></div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">âœï¸ ê¸°ë¡ ìˆ˜ì •</h3>
            <input type="hidden" id="edit-row">
            <div style="margin-bottom:10px;">
                <label style="font-size:12px; font-weight:bold;">ë©”ë‰´ëª…</label>
                <input type="text" id="edit-menu">
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:12px; font-weight:bold;">ìƒíƒœ</label>
                <select id="edit-status" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;">
                    <option value="ì•„ì´ë””ì–´">ì•„ì´ë””ì–´</option>
                    <option value="í…ŒìŠ¤íŠ¸ì¤‘">í…ŒìŠ¤íŠ¸ì¤‘</option>
                    <option value="ì„±ê³µ">ì„±ê³µ</option>
                    <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:12px; font-weight:bold;">ì—°êµ¬ë…¸íŠ¸</label>
                <textarea id="edit-note" style="height:80px;"></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="closeEditModal()" style="flex:1; padding:10px; background:#ccc; border:none; border-radius:4px; cursor:pointer;">ì·¨ì†Œ</button>
                <button onclick="submitEdit()" style="flex:1; padding:10px; background:#2980b9; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">ìˆ˜ì • ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        const gasUrl = "https://script.google.com/macros/s/AKfycbwtNgSrgkjEiaJm4bPIXjddIlU19IYUCgZvx6WIRPLCCar7QndBmiEG-EIaRk3yXLUa/exec";
        
        // ì…°í”„ë‹˜ ì„¤ë¬¸ì§€ ì£¼ì†Œ
        const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSejJy628hEvS5_0QpukHJsFJF228YCEBgW0W6BDutfpjm-UDQ/viewform?embedded=true"; 

        function toggleSubMenu() { const el = document.getElementById('submenu-000'); el.style.display = (el.style.display==='block')?'none':'block'; }
        function goBackMain() { document.querySelectorAll('.workspace').forEach(el=>el.style.display='none'); document.getElementById('main-nav').style.display='block'; document.getElementById('page-title').innerText="MAIN MENU"; }
        
        function openModule(code) {
            document.getElementById('main-nav').style.display='none'; document.querySelectorAll('.workspace').forEach(el=>el.style.display='none');
            const titles = {'010':'010 ìì‚°/ì¬ê³ ', '020':'020 ì†ìµ/ì›ê°€', '030':'030 ì§ì›êµìœ¡', '100':'100~300 ë ˆì‹œí”¼', '400':'400 ì‹¬í™” ì—°êµ¬'};
            document.getElementById('page-title').innerText = titles[code];
            if(code==='010'){document.getElementById('workspace-010').style.display='block'; loadAsset(); setMode('in');}
            else if(code==='020'){document.getElementById('workspace-020').style.display='block'; loadBEP(); loadMenuCost();}
            else if(code==='030'){document.getElementById('workspace-030').style.display='block'; loadManual();}
            else if(code==='100'){document.getElementById('workspace-100').style.display='block'; loadRecipe();}
            else if(code==='400'){
                document.getElementById('workspace-400').style.display='block';
                document.getElementById('google-form-frame').src = formUrl;
                loadRnD();
            }
        }

        // [400] R&D Logic (ì´ë¯¸ì§€ ì²˜ë¦¬ ê°•í™”)
        function loadRnD() {
            const area = document.getElementById('rnd-list-area');
            area.innerHTML = "<p style='text-align:center; color:#999'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>";
            
            fetch(`${gasUrl}?action=rnd`).then(r => r.json()).then(l => {
                if(l.length === 0) { area.innerHTML = "<p style='text-align:center; color:#999'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ ì„¤ë¬¸ì§€ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.</p>"; return; }
                
                let html = "";
                l.forEach(i => {
                    let c = "#777";
                    if(i.status && i.status.includes("ì•„ì´ë””ì–´")) c = "#f39c12";
                    if(i.status && i.status.includes("í…ŒìŠ¤íŠ¸")) c = "#e74c3c";
                    if(i.status && i.status.includes("ì„±ê³µ")) c = "#27ae60";

                    // [ì´ë¯¸ì§€ ì²˜ë¦¬]
                    let imgHtml = "";
                    if (i.photo && i.photo.trim() !== "") {
                        try {
                            // ID ì¶”ì¶œ (ì •ê·œì‹: 25ìë¦¬ ì´ìƒ ë¬¸ìì—´)
                            let match = i.photo.match(/[-\w]{25,}/);
                            if(match) {
                                let fileId = match[0];
                                let thumbUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                                imgHtml = `<div style="margin-top:10px; text-align:center;">
                                     <img src="${thumbUrl}" style="width:100%; max-width:250px; border-radius:8px;" referrerpolicy="no-referrer" onerror="this.style.display='none';">
                                     <div style="margin-top:5px;"><a href="${thumbUrl}" target="_blank" class="photo-link-btn">ğŸ“· ì‚¬ì§„ ë³´ê¸°</a></div>
                                   </div>`;
                            } else {
                                imgHtml = `<div style="margin-top:5px;"><a href="${i.photo}" target="_blank" class="photo-link-btn">ğŸ“· ì‚¬ì§„ ë§í¬</a></div>`;
                            }
                        } catch(e) {}
                    }

                    html += `<div class="info-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; font-size:16px;">${i.menu}</span>
                            <div>
                                <span style="font-size:11px; font-weight:bold; color:${c}; border:1px solid ${c}; padding:2px 6px; border-radius:4px; margin-right:5px;">${i.status}</span>
                                <button onclick='openEditModal(${JSON.stringify(i)})' style="font-size:11px; padding:2px 6px; cursor:pointer;">âœï¸ ìˆ˜ì •</button>
                            </div>
                        </div>
                        <div style="font-size:12px; color:#999; margin-bottom:10px;">${i.date}</div>
                        <p style="font-size:14px; color:#333; white-space:pre-wrap;">${i.note}</p>
                        ${imgHtml}
                    </div>`;
                });
                area.innerHTML = html;
            });
        }

        // ìˆ˜ì • ê¸°ëŠ¥
        function openEditModal(item) {
            document.getElementById('edit-row').value = item.row;
            document.getElementById('edit-menu').value = item.menu;
            document.getElementById('edit-status').value = item.status;
            document.getElementById('edit-note').value = item.note;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
        
        function submitEdit() {
            const item = {
                row: document.getElementById('edit-row').value,
                menu: document.getElementById('edit-menu').value,
                status: document.getElementById('edit-status').value,
                note: document.getElementById('edit-note').value
            };
            const btn = document.querySelector('#edit-modal button:last-child');
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;

            google.script.run.withSuccessHandler(function(res) {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeEditModal();
                btn.innerText = "ìˆ˜ì • ì €ì¥"; btn.disabled = false;
                loadRnD(); 
            }).updateRnDItem(item);
        }

        // [010~100] ê³µí†µ ë¡œì§
        function loadRecipe(){const k=document.getElementById('recipeInput').value;const a=document.getElementById('recipe-list-area');a.innerHTML="<p style='text-align:center;color:#999'>ë¡œë”© ì¤‘...</p>";fetch(`${gasUrl}?action=recipe&keyword=${encodeURIComponent(k)}`).then(r=>r.json()).then(l=>{if(l.length===0){a.innerHTML="<p style='text-align:center;color:#999'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>";return;}let h="";l.forEach(i=>{let g={};i.details.forEach(d=>{if(!g[d.section])g[d.section]=[];g[d.section].push(d)});let b="";for(let s in g){if(!s)continue;let r="";g[s].forEach(row=>{let v=row.video?`<a href="${row.video}" target="_blank" class="video-btn">â–¶ ì˜ìƒ</a>`:"";r+=`<div class="detail-row"><div class="detail-cat">${row.category}</div><div class="detail-content">${row.content}${v}</div></div>`});b+=`<div class="section-block"><div class="section-title">${s}</div>${r}</div>`}h+=`<div class="recipe-card"><div class="recipe-header"><span class="recipe-title">${i.name}</span><span class="recipe-type">${i.type}</span></div><div class="recipe-body">${b}</div></div>`});a.innerHTML=h})}
        let currentMode='in'; let workList=[];
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('searchBtn').addEventListener('click', ()=>{ const v=document.getElementById('searchInput').value; fetch(`${gasUrl}?action=search&item=${v}`).then(r=>r.json()).then(d=>{ let h=""; d.forEach(i=>{h+=`<div style="padding:10px;border-bottom:1px solid #eee;"><b>${i.name}</b> <button class="action-btn" onclick="addToList('${i.name}','${i.spec}','${i.unit}')" style="float:right;padding:5px 10px;">ì¶”ê°€</button></div>`}); document.getElementById('result-list').innerHTML=h; }); });
            document.getElementById('recipeInput').addEventListener('keypress',e=>{if(e.key==='Enter')loadRecipe();});
        });
        function loadAsset(){fetch(`${gasUrl}?action=asset`).then(r=>r.json()).then(d=>document.getElementById('asset-value').innerText=Number(d.total).toLocaleString()+" ì›")}
        function loadBEP(){fetch(`${gasUrl}?action=bep`).then(r=>r.json()).then(d=>{document.getElementById('fin-current').innerText=Number(d.current).toLocaleString();const p=document.getElementById('fin-profit');p.innerText=Number(d.netProfit).toLocaleString();p.className=d.netProfit>0?"finance-val finance-profit plus":"finance-val finance-profit"})}
        function loadMenuCost(){fetch(`${gasUrl}?action=menu_cost`).then(r=>r.json()).then(l=>{let h="";l.forEach(i=>{let c=i.ratio>35?"cost-bad":"cost-good";h+=`<div class="menu-card"><div><b>${i.name}</b><br><small>${Number(i.cost).toLocaleString()}/${Number(i.price).toLocaleString()}</small></div><div class="cost-badge ${c}">${i.ratio}%</div></div>`});document.getElementById('menu-list-area').innerHTML=h})}
        function loadManual(){fetch(`${gasUrl}?action=manual`).then(r=>r.json()).then(l=>{let h="";l.forEach(i=>{let link=i.link?`<a href="${i.link}" target="_blank">ğŸ”— ì˜ìƒ</a>`:"";h+=`<div class="info-card"><b>${i.title}</b><br><small>${i.category}</small><p>${i.content}</p>${link}</div>`});document.getElementById('manual-list-area').innerHTML=h})}
        function loadStock(){setMode('stock');fetch(`${gasUrl}?action=inventory`).then(r=>r.json()).then(d=>{let h='<table>';d.forEach(i=>{h+=`<tr><td>${i.name}</td><td>${i.qty}</td></tr>`});document.getElementById('result-list').innerHTML=h+'</table>'})}
        function setMode(m){currentMode=m; document.getElementById('work-area').style.display=m==='stock'?'none':'block'; document.getElementById('search-area').style.display=m==='stock'?'none':'flex'; document.getElementById('result-list').innerHTML=""}
        function addToList(n,s,u){workList.push({date:new Date().toISOString().split('T')[0],name:n,spec:s,unit:u,qty:1}); renderList()}
        function saveToSheet(){fetch(`${gasUrl}?action=save&type=${currentMode}&data=${encodeURIComponent(JSON.stringify(workList))}`).then(()=>{alert("ì™„ë£Œ");workList=[];renderList()})}
    </script>
</body>
</html>

function doGet(e) {
  const action = e.parameter.action;
  const ssId = "1hJ_72IAyBJr06p3jGgEB5AlQT23OSDB7xKVEVt0H_o0";
  const ss = SpreadsheetApp.openById(ssId);

  // 1. 검색 (기존 유지)
  if (action === "search") {
    const itemName = e.parameter.item;
    const sheet = ss.getSheets()[0]; 
    const data = sheet.getDataRange().getValues();
    let results = [];
    for (let i = 1; i < data.length; i++) {
       let nameInSheet = data[i][2] ? data[i][2].toString() : ""; 
       if (nameInSheet.replace(/\s/g, "").includes(itemName.replace(/\s/g, ""))) {
         results.push({ name: data[i][2], spec: data[i][3], unit: data[i][4] });
       }
    }
    return ContentService.createTextOutput(JSON.stringify(results)).setMimeType(ContentService.MimeType.JSON);
  }

  // 2. 저장 (기존 유지)
  if (action === "save") {
    const type = e.parameter.type;
    const items = JSON.parse(e.parameter.data);
    let sheetName = (type === "in") ? "매입장" : "출고장";
    const sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
    items.forEach(item => {
      sheet.appendRow([item.date, item.name, item.spec, item.unit, item.qty]);
    });
    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
  }

  // 3. 재고 조회 (기존 유지)
  if (action === "inventory") {
    const inSheet = ss.getSheetByName("매입장");
    const outSheet = ss.getSheetByName("출고장");
    let stockMap = {};

    if (inSheet) {
      const inData = inSheet.getDataRange().getValues();
      for (let i = 0; i < inData.length; i++) {
        let key = inData[i][1] + " (" + inData[i][2] + ")";
        let qty = Number(inData[i][4]) || 0;
        if (!stockMap[key]) stockMap[key] = { name: inData[i][1], spec: inData[i][2], unit: inData[i][3], qty: 0 };
        stockMap[key].qty += qty;
      }
    }
    if (outSheet) {
      const outData = outSheet.getDataRange().getValues();
      for (let i = 0; i < outData.length; i++) {
        let key = outData[i][1] + " (" + outData[i][2] + ")";
        let qty = Number(outData[i][4]) || 0;
        if (stockMap[key]) stockMap[key].qty -= qty;
      }
    }
    let results = [];
    for (let key in stockMap) {
      if (stockMap[key].qty !== 0) results.push(stockMap[key]);
    }
    return ContentService.createTextOutput(JSON.stringify(results)).setMimeType(ContentService.MimeType.JSON);
  }

  // 4. [NEW] 총 자산 조회 (기초재고 탭 활용)
  if (action === "asset") {
    const sheet = ss.getSheetByName("기초재고");
    if (!sheet) return ContentService.createTextOutput("0").setMimeType(ContentService.MimeType.TEXT);
    
    const data = sheet.getDataRange().getValues();
    let totalAsset = 0;

    // I열(인덱스 8)이 '총 재고 자산'입니다.
    // 2행부터 끝까지 더합니다.
    for (let i = 1; i < data.length; i++) {
      let val = Number(data[i][8]); // I열 값
      if (!isNaN(val)) totalAsset += val;
    }
    
    return ContentService.createTextOutput(totalAsset.toString()).setMimeType(ContentService.MimeType.TEXT);
  }
}
